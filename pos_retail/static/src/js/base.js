odoo.define('pos_retail.base', function (require) {
    var models = require('point_of_sale.models');
    var _super_posmodel = models.PosModel.prototype;
    var rpc = require('pos.rpc');

    _super_posmodel.push_and_invoice_order = function (order) {
        var self = this;
        var invoiced = new $.Deferred();

        if (!order.get_client()) {
            invoiced.reject({code: 400, message: 'Missing Customer', data: {}});
            return invoiced;
        }

        var order_id = this.db.add_order(order.export_as_JSON());

        this.flush_mutex.exec(function () {
            var done = new $.Deferred(); // holds the mutex

            // send the order to the server
            // we have a 30 seconds timeout on this push.
            // FIXME: if the server takes more than 30 seconds to accept the order,
            // the client will believe it wasn't successfully sent, and very bad
            // things will happen as a duplicate will be sent next time
            // so we must make sure the server detects and ignores duplicated orders

            var transfer = self._flush_orders([self.db.get_order(order_id)], {timeout: 30000, to_invoice: true});

            transfer.fail(function (error) {
                invoiced.reject(error);
                done.reject();
            });

            // on success, get the order id generated by the server
            //----------------------------------------
            // bruce.nguyen customize
            //----------------------------------------
            if (!self.config.invoice_offline) {
                transfer.pipe(function (order_server_id) {
                    rpc.query({
                        model: "account.invoice",
                        method: 'search_read',
                        domain: [['pos_order_id', '=', order_server_id]],
                        fields: ['id', 'journal_id']
                    }).then(function (data) {
                        var invoice = data[0];
                        console.log(invoice);
                        if(invoice.journal_id[1] == "Factura Consumidor Final (USD)" ||
                        invoice.journal_id[1] == "Factura Consumidor Final (USD)"){
                            self.chrome.do_action('l10n_invoice_sv.jasper_fcf_report_demo', {
                                additional_context: {
                                    active_ids: [invoice.id],
                                }
                            }).done(function () {
                                invoiced.resolve();
                                done.resolve();
                            });
                        }else if(invoice.journal_id[1] == "Orden De Pedido (USD)" ||
                            invoice.journal_id[1] == "Orden De Pedido (USD)"){
                            self.chrome.do_action('l10n_invoice_sv.report_orden_de_pedido', {
                                additional_context: {
                                    active_ids: [invoice.id],
                                }
                            }).done(function () {
                                invoiced.resolve();
                                done.resolve();
                            });
                        }else if(invoice.journal_id[1] == "Comprobante Credito Fiscal (USD)" ||
                            invoice.journal_id[1] == "Comprobante Credito Fiscal (SVC)"){
                            self.chrome.do_action('l10n_invoice_sv.jasper_ccf_report_demo', {
                                additional_context: {
                                    active_ids: [invoice.id],
                                }
                            }).done(function () {
                                invoiced.resolve();
                                done.resolve();
                            });
                        }
                        else if(invoice.journal_id[1] == "Ticket (USD)" || invoice.journal_id[1] == "Ticket (SVC)"){
                            self.chrome.do_action('l10n_invoice_sv.jasper_tck_report_demo', {
                                additional_context: {
                                    active_ids: [invoice.id],
                                }
                            }).done(function () {
                                invoiced.resolve();
                                done.resolve();
                            });
                        }
                    }).fail(function (error) {
                        console.log(error);
                    });
                });
            } else {
                invoiced.resolve();
                done.resolve();
            }
            return done;

        });

        return invoiced;
    }
});
